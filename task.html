<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>AIRDROP USDT KE – Tasks</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyD2Dqz6jg8YACBvg_G_7yIR6c8sSH39BsQ",
  authDomain: "cypx-onlinecrypto.firebaseapp.com",
  databaseURL: "https://cypx-onlinecrypto-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "cypx-onlinecrypto",
  storageBucket: "cypx-onlinecrypto.firebasestorage.app",
  messagingSenderId: "857500807275",
  appId: "1:857500807275:web:0e04242866ff30bec3812e",
  measurementId: "G-7PXLNKJLXV"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.database();
</script>

<style>
html,body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:linear-gradient(180deg,#000428,#004e92);
  color:#fff;
  -webkit-user-select:none;
  user-select:none;
}
input,textarea,select,button{-webkit-user-select:auto;user-select:auto}

/* header */
header{
  background:rgba(0,0,0,0.4);
  backdrop-filter:blur(6px);
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px 16px;
  border-bottom:1px solid rgba(255,255,255,0.1);
}
header img{height:34px}
header h2{margin:0;font-size:1.2rem;color:#ffcc00}

/* stats grid */
.stats{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:10px;
  margin:14px;
}
.stat-box{
  background:rgba(255,255,255,0.08);
  padding:12px;
  border-radius:10px;
  text-align:center;
  box-shadow:0 0 10px rgba(255,204,0,0.1);
  transition:transform 0.2s;
}
.stat-box:hover{transform:scale(1.02)}
.stat-box h3{margin:0 0 4px 0;color:#ffcc00;font-size:0.9rem}
.stat-box p{margin:0;font-size:1.2rem;font-weight:700}

/* task/history card */
.history{
  margin:12px;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.08);
  border-radius:10px;
  padding:10px;
  margin-top:1cm;
  margin-bottom:0.5cm;
  max-height:420px;
  overflow-y:auto;
}
.history h3{margin:0 0 8px 0;color:#ffcc00;}
.history .row{
  display:flex;
  justify-content:space-between;
  padding:4px 0;
  border-bottom:1px dotted rgba(255,255,255,0.1);
  color:#cfe6ff;
  font-size:0.9rem;
}

/* popup */
.popup{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#28a745;
  color:#fff;
  padding:16px 22px;
  border-radius:8px;
  font-weight:600;
  z-index:9999;
  text-align:center;
  box-shadow:0 0 15px 2px rgba(255,255,255,0.2);
  animation:fadein 0.3s ease-in-out;
}
.popup.red{background:#cc0000}
@keyframes fadein{from{opacity:0;transform:translate(-50%,-60%)}to{opacity:1;transform:translate(-50%,-50%)}}

/* bottom nav */
nav{
  position:fixed;
  bottom:0; left:0; right:0;
  display:flex;
  justify-content:space-around;
  background:rgba(0,0,0,0.5);
  backdrop-filter:blur(6px);
  padding:8px 0;
}
nav a{
  color:#fff;
  text-decoration:none;
  text-align:center;
  font-size:0.8rem;
}
nav i{font-size:18px}

/* bottom padding */
body::after{content:"";display:block;height:0.6cm;}
</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<header>
  <img src="https://png.pngtree.com/png-clipart/20221216/original/pngtree-vip-icon-design-png-image_8749175.png" alt="logo">
  <h2>AIRDROP USDT KE – Tasks</h2>
</header>

<div class="stats">
  <div class="stat-box"><h3>Total Levels</h3><p id="total-vips">0</p></div>
  <div class="stat-box"><h3>Unlocked</h3><p id="opened-vips">0</p></div>
  <div class="stat-box"><h3>Ongoing</h3><p id="ongoing-vips">0</p></div>
  <div class="stat-box"><h3>Completed</h3><p id="completed-vips">0</p></div>
</div>

<div class="history">
  <h3>Task / Action History</h3>
  <div id="task-history"></div>
</div>

<nav>
  <a href="dashboard.html"><i class="fas fa-home"></i><br>Home</a>
  <a href="task.html"><i class="fas fa-tasks"></i><br>Tasks</a>
  <a href="team.html"><i class="fas fa-users"></i><br>Team</a>
  <a href="vip.html"><i class="fas fa-crown"></i><br>VIP</a>
  <a href="profile.html"><i class="fas fa-user"></i><br>Profile</a>
</nav>

<script>
auth.onAuthStateChanged(user=>{
  if(!user){ window.location='signin.html'; return; }
  const uid = user.uid;
  const userRef = db.ref('users/'+uid);
  const investRef = userRef.child('investments');
  const statsRef = userRef.child('vipStats');
  const historyRef = userRef.child('taskHistory');
  const totalVipLevels = 10;

  // --- Compute stats and update Firebase ---
  function updateVipStats(snapshot){
    const data = snapshot.val() || {};
    let opened=0, ongoing=0, completed=0;

    Object.keys(data).forEach(k=>{
      const v = data[k];
      if(!v) return;
      if(v.status === 'active'){ opened++; ongoing++; }
      if(v.status === 'completed'){ opened++; completed++; }
    });

    document.getElementById('total-vips').textContent = totalVipLevels;
    document.getElementById('opened-vips').textContent = opened;
    document.getElementById('ongoing-vips').textContent = ongoing;
    document.getElementById('completed-vips').textContent = completed;

    statsRef.update({ opened, ongoing, completed, total: totalVipLevels });
  }

  investRef.on('value', updateVipStats);

  // --- Record new investment actions ---
  investRef.on('child_added', snap=>{
    const v = snap.val(); if(!v) return;
    const time = Date.now();
    const action = `Invested in VIP plan (${v.investedAmount} KSH)`;
    historyRef.push({ action, timestamp: time });
  });

  // --- Record completion actions ---
  investRef.on('child_changed', snap=>{
    const v = snap.val(); if(!v) return;
    const time = Date.now();
    let action='';
    if(v.status==='completed') action=`Completed VIP plan (${v.investedAmount} KSH)`;
    if(action) historyRef.push({ action, timestamp: time });
  });

  // --- Display history live ---
  historyRef.limitToLast(50).on('value', snap=>{
    const data = snap.val() || {};
    const cont = document.getElementById('task-history');
    cont.innerHTML='';
    const items = Object.values(data).sort((a,b)=>b.timestamp-a.timestamp);
    items.forEach(item=>{
      const row=document.createElement('div');
      row.className='row';
      const t=new Date(item.timestamp).toLocaleString();
      row.innerHTML=`<div>${item.action}</div><div>${t}</div>`;
      cont.appendChild(row);
    });
  });
});

// popup
function showPopup(msg, red=false){
  const p=document.createElement('div');
  p.className='popup'+(red?' red':'');
  p.textContent=msg;
  document.body.appendChild(p);
  setTimeout(()=>p.remove(),3000);
}
</script>

</body>
</html>
